 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #030712;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 2rem 2rem;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .truncate-text {
            @apply truncate;
        }
    </style>
</head>
<body class="text-gray-200">
    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <svg class="h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                </svg>
                <h1 id="candidate-name-header" class="text-2xl font-bold text-white">Candidate Dashboard</h1>
            </div>
            <a href="/api/logout" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Logout</a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: My Applications -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-2xl shadow-lg sticky top-8">
                    <h2 class="text-xl font-bold mb-4 text-white">My Applications</h2>
                    <div id="my-applications-container" class="space-y-3 max-h-[60vh] overflow-y-auto">
                        <p class="text-gray-400">Loading your applications...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Job Listings -->
            <div class="lg:col-span-2">
                 <h2 class="text-xl font-bold mb-4 text-white">Available Job Openings</h2>
                 <div id="jobs-container" class="space-y-4">
                    <p class="text-gray-400">Loading jobs...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Application Modal -->
    <div id="application-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 modal-overlay opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-6 border-b border-gray-700 flex-shrink-0">
                <h2 id="modal-job-title" class="text-2xl font-bold text-white">Job Title</h2>
                <p id="modal-company-name" class="text-md text-indigo-400"></p>
            </header>
            <main class="p-6 overflow-y-auto flex-grow">
                <h3 class="font-bold text-lg mb-2">Job Description</h3>
                <p id="modal-job-description" class="text-gray-300 whitespace-pre-wrap"></p>
            </main>
            <footer class="p-6 border-t border-gray-700 flex-shrink-0 bg-gray-800/50 backdrop-blur-sm">
                <form id="apply-form" class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Upload Your Resume to Apply</label>
                        <div class="flex items-center gap-4">
                            <label class="bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer">
                                <span>Choose File (PDF/DOCX)</span>
                                <input type="file" id="resume-file-input" class="hidden" accept=".pdf,.docx" required>
                            </label>
                            <span id="resume-file-name" class="text-sm text-gray-500 truncate">No file selected...</span>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="close-modal-btn" class="py-2 px-4 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancel</button>
                        <button type="submit" id="submit-application-btn" class="py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Submit Application</button>
                    </div>
                </form>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const candidateName = sessionStorage.getItem('candidateName') || 'Candidate';
            document.getElementById('candidate-name-header').textContent = `Welcome, ${candidateName}`;

            const jobsContainer = document.getElementById('jobs-container');
            const myApplicationsContainer = document.getElementById('my-applications-container');
            const modal = document.getElementById('application-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const applyForm = document.getElementById('apply-form');
            const resumeFileInput = document.getElementById('resume-file-input');
            const resumeFileName = document.getElementById('resume-file-name');
            const submitApplicationBtn = document.getElementById('submit-application-btn');
            let selectedJobId = null;
            let resumeTextContent = null;

            async function loadData() {
                try {
                    const [jobs, applications] = await Promise.all([
                        fetch('/api/jobs').then(res => res.json()),
                        fetch('/api/candidate/applications').then(res => res.json())
                    ]);
                    
                    jobsContainer.innerHTML = jobs.length
                        ? jobs.map(job => `
                            <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-lg flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-white">${job.title}</h3>
                                    <p class="text-sm text-indigo-400">${job.company_name}</p>
                                </div>
                                <button class="py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition" data-job-id="${job.id}">View & Apply</button>
                            </div>`).join('')
                        : '<p class="text-gray-400">No open positions at the moment.</p>';

                    myApplicationsContainer.innerHTML = applications.length
                        ? applications.map(app => {
                            let statusColor = 'text-gray-400';
                            if (['Shortlisted','Invited','Accepted'].includes(app.status)) statusColor = 'text-green-400';
                            if (app.status === 'Rejected') statusColor = 'text-red-400';
                            return `
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <p class="font-bold text-white">${app.title}</p>
                                    <p class="text-xs text-gray-500">${app.company_name}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <p class="text-sm font-bold ${statusColor}">${app.status}</p>
                                        ${app.status === 'Rejected' && app.report_path ? `<a href="${app.report_path}" target="_blank" class="text-xs text-indigo-400 hover:underline">View Report</a>` : ''}
                                    </div>
                                </div>`;
                        }).join('')
                        : '<p class="text-gray-400 text-sm">You have not applied to any jobs yet.</p>';

                } catch (error) {
                    console.error("Failed to load dashboard data:", error);
                    window.location.href = '/';
                }
            }

            function openModal(job) {
                selectedJobId = job.id;
                document.getElementById('modal-job-title').textContent = job.title;
                document.getElementById('modal-company-name').textContent = job.company_name;
                document.getElementById('modal-job-description').textContent = job.description;
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            }

            function closeModal() {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    applyForm.reset();
                    resumeFileName.textContent = "No file selected...";
                    submitApplicationBtn.disabled = true;
                    resumeTextContent = null;
                }, 300);
            }

            jobsContainer.addEventListener('click', async (e) => {
                if(e.target.matches('button[data-job-id]')) {
                    const jobId = e.target.dataset.jobId;
                    try {
                        const jobs = await (await fetch('/api/jobs')).json();
                        const job = jobs.find(j => j.id == jobId);
                        if(job) openModal(job);
                    } catch (error) {
                        console.error("Failed to fetch job details:", error);
                    }
                }
            });

            closeModalBtn.addEventListener('click', closeModal);

            resumeFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                resumeFileName.textContent = `Uploading...`;
                submitApplicationBtn.disabled = true;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/extract_text', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    resumeTextContent = data.text;
                    resumeFileName.textContent = `✓ ${file.name}`;
                    submitApplicationBtn.disabled = false;
                } catch(error) {
                    resumeFileName.textContent = `✗ Error`;
                    alert(error.message);
                }
            });

            applyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!resumeTextContent) {
                    alert('Please upload a valid resume file.');
                    return;
                }
                const btn = submitApplicationBtn;
                const originalText = btn.textContent;
                btn.textContent = 'Submitting...';
                btn.disabled = true;
                try {
                     const response = await fetch(`/api/apply/${selectedJobId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resume_text: resumeTextContent })
                    });
                    const data = await response.json();
                    if(!response.ok) throw new Error(data.error);
                    alert(data.message);
                    closeModal();
                    loadData();
                } catch(error) {
                    alert(error.message);
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            loadData();
        });
    </script>
</body>
</html>
