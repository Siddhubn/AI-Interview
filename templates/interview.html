<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview for {{ job_title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .hidden { display: none !important; }
        .video-container { position: relative; background-color: #1F2937; overflow: hidden; width: 100%; height: 100%; }
        .video-container video, .video-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .proctor-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(220, 38, 38, 0.5); color: white; font-size: 2rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        .proctor-overlay.visible { opacity: 1; }
    </style>
</head>
<body class="text-gray-200">
    <div id="app-root" class="w-full min-h-screen">
        <section id="candidate-setup-view" class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-6 text-center">
                 <h2 class="text-3xl font-bold">Interview for {{ job_title }}</h2>
                 <p class="text-gray-400">Please upload your resume and allow camera access to begin the proctored interview.</p>
                 <div>
                    <label class="bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer inline-block">
                        <span>Upload Resume (PDF/DOCX)</span>
                        <input type="file" id="candidate-resume-input" class="hidden" accept=".pdf,.docx">
                    </label>
                    <p id="candidate-file-name" class="text-sm text-gray-500 truncate mt-2">No file selected...</p>
                </div>
                <button id="start-interview-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed transition" disabled>
                    Start Proctored Interview
                </button>
            </div>
        </section>

        <section id="interview-view" class="hidden w-full h-screen p-4 flex flex-col">
            <header class="flex-shrink-0 flex justify-between items-center pb-4">
                <h1 class="text-xl font-bold">AI Virtual Interview</h1>
                <div class="flex items-center gap-2">
                    <span id="proctor-status-indicator" class="h-3 w-3 rounded-full bg-gray-500"></span>
                    <span id="proctor-status-text" class="text-sm font-medium">Proctoring Offline</span>
                </div>
            </header>
            <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 min-h-0">
                <div class="video-container rounded-lg flex flex-col justify-between p-6">
                    <h2 class="text-2xl font-bold">AI Interviewer</h2>
                    <p id="question-text" class="text-2xl font-medium text-center"></p>
                    <div id="ai-status" class="bg-indigo-500 text-white rounded-full px-4 py-1 inline-flex items-center gap-2 self-start">
                        <span class="w-3 h-3 bg-white rounded-full"></span>
                        <span id="ai-status-text">Initializing...</span>
                    </div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="video-container rounded-lg flex-grow">
                        <video id="input_video" style="display: none;" autoplay muted playsinline></video>
                        <canvas id="output_canvas"></canvas>
                        <div id="proctor-warning-overlay" class="proctor-overlay rounded-lg"><span id="proctor-warning-text"></span></div>
                        <div id="timer-display" class="absolute top-4 right-4 bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm font-bold">02:00</div>
                        <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm">Candidate</div>
                    </div>
                    <textarea id="answer-textarea" class="w-full h-24 p-3 bg-gray-900 border border-gray-700 rounded-lg" placeholder="Your transcribed answer..." readonly></textarea>
                </div>
            </main>
            <footer class="flex-shrink-0 pt-4 flex justify-center items-center gap-4 h-20">
                 <button id="record-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Start Answering</button>
                 <button id="next-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hidden">Next Question</button>
            </footer>
        </section>

        <section id="end-view" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-12 text-center space-y-4">
                <h2 class="text-3xl font-bold">Interview Submitted</h2>
                <p class="text-gray-400">Thank you for completing the interview. Your results have been sent to the hiring manager.</p>
                <p class="text-lg">You may now close this window.</p>
            </div>
        </section>
    </div>
    
    <script type="module">
        const JOB_ID = {{ job_id }};
        // --- All the same JavaScript from the previous "full index.html" goes here ---
        // It includes all the logic for proctoring, speech-to-text, timers, etc.
        // The core change is how it's initialized.
        
        // --- State ---
        const appState = {
            resumeText: null, questions: [], interviewResults: [], proctoringFlags: [], currentQuestionIndex: 0,
            isRecording: false, answerTimerInterval: null, accumulatedTranscript: ""
        };
        // ... (rest of the state and element selectors for the interview view) ...
        const resumeInput = document.getElementById('candidate-resume-input');
        const fileNameEl = document.getElementById('candidate-file-name');
        const startBtn = document.getElementById('start-interview-btn');
        // ... etc.

        // --- Init Function ---
        function initCandidateInterview() {
            resumeInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                fileNameEl.textContent = `Uploading...`;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/extract_text', { method: 'POST', body: formData });
                    const data = await response.json();
                    if(!response.ok) throw new Error(data.error);
                    appState.resumeText = data.text;
                    fileNameEl.textContent = `✓ ${file.name}`;
                    startBtn.disabled = false;
                } catch(err) { fileNameEl.textContent = `✗ Error`; startBtn.disabled = true; alert(err.message); }
            };

            startBtn.onclick = async () => {
                document.getElementById('candidate-setup-view').classList.add('hidden');
                document.getElementById('interview-view').classList.remove('hidden');

                try {
                    const data = await fetch('/api/start_interview', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ job_id: JOB_ID, resume_text: appState.resumeText })
                    }).then(res => res.json());

                    appState.questions = data.questions;
                    initInterviewView();
                } catch (err) {
                    alert('Could not start the interview. Please try again.');
                    document.getElementById('candidate-setup-view').classList.remove('hidden');
                    document.getElementById('interview-view').classList.add('hidden');
                }
            };
        }

        function initInterviewView() {
            // This function and all its helpers (proctoring, speech, etc.)
            // are identical to the complete JS block in the previous turn's full index.html file.
            // It would start with selectors for interview elements, then proctoring logic, etc.
            // and end with the event listeners for the record and next buttons.
        }

        initCandidateInterview();
    </script>
</body>
</html>