<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Platform</title>
    
    <!-- MediaPipe Libraries for Proctoring -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
    <!-- Fonts and Styling -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .video-container { position: relative; background-color: #1F2937; overflow: hidden; width: 100%; height: 100%; }
        .video-container video, .video-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .proctor-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(220, 38, 38, 0.5); color: white; font-size: 2rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        .proctor-overlay.visible { opacity: 1; }
    </style>
</head>
<body class="text-gray-200">

    <!-- Main Application Container -->
    <div id="app-root" class="w-full min-h-screen">

        <!-- ===== ADMIN AUTHENTICATION VIEW ===== -->
        <section id="auth-view" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md">
                <div id="login-form-container">
                    <form id="login-form" class="bg-gray-800 p-8 rounded-2xl shadow-lg space-y-6">
                        <h2 class="text-3xl font-bold text-center text-white">Admin Login</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-400">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-400">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Login</button>
                        <p class="text-center text-sm text-gray-400">
                            Don't have an account? <button type="button" id="show-register-btn" class="font-medium text-indigo-400 hover:underline">Sign up</button>
                        </p>
                    </form>
                </div>
                <div id="register-form-container" class="hidden">
                    <form id="register-form" class="bg-gray-800 p-8 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-3xl font-bold text-center text-white">Admin Registration</h2>
                        <input type="text" id="register-company" placeholder="Company Name" required class="block w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                        <input type="email" id="register-email" placeholder="Email Address" required class="block w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                        <input type="tel" id="register-phone" placeholder="Phone Number" required class="block w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                        <input type="password" id="register-password" placeholder="Password" required class="block w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Register</button>
                         <p class="text-center text-sm text-gray-400">
                            Already have an account? <button type="button" id="show-login-btn" class="font-medium text-indigo-400 hover:underline">Log in</button>
                        </p>
                    </form>
                </div>
                <p id="auth-error" class="text-red-400 text-center mt-4"></p>
            </div>
        </section>

        <!-- ===== ADMIN DASHBOARD VIEW ===== -->
        <section id="dashboard-view" class="hidden p-4 md:p-8">
            <header class="flex justify-between items-center mb-6">
                <h1 id="company-name-header" class="text-2xl font-bold">Admin Dashboard</h1>
                <button id="logout-btn" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Logout</button>
            </header>
            
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-xl font-bold mb-4">Create New Job Posting</h2>
                <form id="create-job-form" class="space-y-4">
                    <input type="text" id="job-title" placeholder="Job Title (e.g., Senior Python Developer)" required class="w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                    
                    <div class="space-y-2">
                         <label class="block text-sm font-medium text-gray-400">Job Description</label>
                         <div class="flex flex-wrap gap-2">
                             <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="frontend">Frontend Developer</button>
                             <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="backend">Backend Developer</button>
                             <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="devops">DevOps Engineer</button>
                             <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="data-scientist">Data Scientist</button>
                         </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <label class="bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer">
                            <span>Upload JD (PDF/DOCX)</span>
                            <input type="file" id="jd-file-input" class="hidden" accept=".pdf,.docx">
                        </label>
                         <textarea id="job-description" placeholder="Or paste job description here..." required class="w-full h-24 p-3 bg-gray-900 border border-gray-700 rounded-lg"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Create Job & Get Link</button>
                </form>
                <div id="interview-link-container" class="mt-4 hidden">
                    <p class="text-green-400">Share this link with candidates:</p>
                    <input id="interview-link-input" type="text" readonly class="w-full bg-gray-900 p-2 rounded-md border border-gray-700 mt-2">
                </div>
            </div>

            <div id="jobs-container">
                <p class="text-gray-400">Loading jobs...</p>
            </div>
        </section>

        <!-- ===== CANDIDATE SETUP VIEW ===== -->
        <section id="candidate-setup-view" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-6">
                 <h2 class="text-3xl font-bold text-center">Candidate Interview Setup</h2>
                 <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Please upload your resume to begin.</label>
                    <div class="flex items-center gap-4">
                        <label class="bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer">
                            <span>Upload Resume (PDF/DOCX)</span>
                            <input type="file" id="candidate-resume-input" class="hidden" accept=".pdf,.docx">
                        </label>
                        <span id="candidate-file-name" class="text-sm text-gray-500 truncate">No file selected...</span>
                    </div>
                </div>
                <button id="start-interview-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed transition" disabled>
                    Start Proctored Interview
                </button>
            </div>
        </section>

        <!-- ===== INTERVIEW VIEW (SHARED) ===== -->
        <section id="interview-view" class="hidden w-full h-screen p-4 flex flex-col">
            <header class="flex-shrink-0 flex justify-between items-center pb-4">
                <h1 class="text-xl font-bold">AI Virtual Interview</h1>
                <div class="flex items-center gap-2">
                    <span id="proctor-status-indicator" class="h-3 w-3 rounded-full bg-gray-500"></span>
                    <span id="proctor-status-text" class="text-sm font-medium">Proctoring Offline</span>
                </div>
            </header>
            <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 min-h-0">
                <div class="video-container rounded-lg flex flex-col justify-between p-6">
                    <h2 class="text-2xl font-bold">AI Interviewer</h2>
                    <p id="question-text" class="text-2xl font-medium text-center"></p>
                    <div id="ai-status" class="bg-indigo-500 text-white rounded-full px-4 py-1 inline-flex items-center gap-2 self-start">
                        <span class="w-3 h-3 bg-white rounded-full pulse"></span>
                        <span id="ai-status-text">Initializing...</span>
                    </div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="video-container rounded-lg flex-grow">
                        <video id="input_video" style="display: none;" autoplay muted playsinline></video>
                        <canvas id="output_canvas"></canvas>
                        <div id="proctor-warning-overlay" class="proctor-overlay rounded-lg"><span id="proctor-warning-text"></span></div>
                        <div id="timer-display" class="absolute top-4 right-4 bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm font-bold">02:00</div>
                        <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm">Candidate</div>
                    </div>
                    <textarea id="answer-textarea" class="w-full h-24 p-3 bg-gray-900 border border-gray-700 rounded-lg" placeholder="Your transcribed answer..." readonly></textarea>
                </div>
            </main>
            <footer class="flex-shrink-0 pt-4 flex justify-center items-center gap-4 h-20">
                 <button id="record-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Start Answering</button>
                 <button id="next-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hidden">Next Question</button>
            </footer>
        </section>

        <!-- ===== END VIEW (CANDIDATE) ===== -->
        <section id="end-view" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-12 text-center space-y-4">
                <h2 class="text-3xl font-bold">Interview Submitted</h2>
                <p class="text-gray-400">Thank you for completing the interview. Your results have been sent to the hiring manager.</p>
                <p class="text-lg">You may now close this window.</p>
            </div>
        </section>
    </div>
    
    <script type="module">
        // --- State Management ---
        const appState = {
            view: '', jobId: null, resumeText: null, jobRequirements: null, questions: [],
            interviewResults: [], proctoringFlags: [], currentQuestionIndex: 0, isRecording: false,
            answerTimerInterval: null, accumulatedTranscript: ""
        };
        const proctoringState = { faceMesh: null, camera: null, focusTimeout: null, multiFaceTimeout: null };

        // --- DOM Elements ---
        const views = {
            auth: document.getElementById('auth-view'), dashboard: document.getElementById('dashboard-view'),
            candidateSetup: document.getElementById('candidate-setup-view'),
            interview: document.getElementById('interview-view'), end: document.getElementById('end-view')
        };
        const videoElement = document.getElementById('input_video'), canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // --- Router ---
        async function navigate() {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            const path = window.location.pathname;

            if (path.startsWith('/interview/')) {
                appState.jobId = path.split('/')[2];
                appState.view = 'candidateSetup';
            } else {
                try {
                    const session = await apiCall('/api/check_session');
                    appState.view = session.logged_in ? 'dashboard' : 'auth';
                    if(session.logged_in) sessionStorage.setItem('companyName', session.company_name);
                } catch (e) {
                    appState.view = 'auth';
                }
            }
            views[appState.view].classList.remove('hidden');
            if (appState.view === 'auth') initAuthView();
            if (appState.view === 'dashboard') initDashboardView();
            if (appState.view === 'candidateSetup') initCandidateSetupView();
        }

        // --- API Helper ---
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                if (response.headers.get("Content-Type")?.includes("application/json")) {
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'An API error occurred.');
                    return data;
                }
                if (!response.ok) throw new Error('A network error occurred.');
                return response;
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                alert(`Error: ${error.message}`);
                throw error;
            }
        }
        
        // --- AUTH VIEW ---
        function initAuthView() {
            const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn'), showLoginBtn = document.getElementById('show-login-btn');
            const authErrorEl = document.getElementById('auth-error');

            showRegisterBtn.onclick = () => {
                document.getElementById('login-form-container').classList.add('hidden');
                document.getElementById('register-form-container').classList.remove('hidden');
            };
            showLoginBtn.onclick = () => {
                document.getElementById('register-form-container').classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
            };
            loginForm.onsubmit = async (e) => {
                e.preventDefault();
                authErrorEl.textContent = '';
                try {
                    const data = await apiCall('/api/login', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: e.target.elements['login-email'].value, password: e.target.elements['login-password'].value })
                    });
                    sessionStorage.setItem('companyName', data.company_name);
                    navigate();
                } catch (error) { authErrorEl.textContent = error.message; }
            };
            registerForm.onsubmit = async (e) => {
                e.preventDefault();
                authErrorEl.textContent = '';
                try {
                    const data = await apiCall('/api/register', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company_name: e.target.elements['register-company'].value, email: e.target.elements['register-email'].value,
                            phone: e.target.elements['register-phone'].value, password: e.target.elements['register-password'].value
                        })
                    });
                    alert(data.message);
                    showLoginBtn.click();
                } catch (error) { authErrorEl.textContent = error.message; }
            };
        }
        
        // --- DASHBOARD VIEW ---
        function initDashboardView() {
            document.getElementById('company-name-header').textContent = `${sessionStorage.getItem('companyName')} Dashboard`;
            const createJobForm = document.getElementById('create-job-form');
            const jobsContainer = document.getElementById('jobs-container');
            const linkContainer = document.getElementById('interview-link-container');
            const linkInput = document.getElementById('interview-link-input');
            const jdFileInput = document.getElementById('jd-file-input');
            const jobDescriptionEl = document.getElementById('job-description');
            const jobTitleEl = document.getElementById('job-title');
            const jdTemplateButtons = document.querySelectorAll('.jd-template-btn');

            const jobTemplates = {
                'frontend': { title: 'Frontend Developer', desc: 'Seeking a skilled Frontend Developer with experience in HTML, CSS, JavaScript, and modern frameworks like React or Vue.js. The ideal candidate will be passionate about creating responsive, user-friendly interfaces and collaborating with our design team to bring concepts to life.'},
                'backend': { title: 'Backend Developer', desc: 'We are looking for a Backend Developer proficient in server-side languages such as Python, Node.js, or Java. Responsibilities include designing and managing databases (SQL/NoSQL), building robust APIs, and ensuring the performance and scalability of our application.'},
                'devops': { title: 'DevOps Engineer', desc: 'Hiring a DevOps Engineer to manage our CI/CD pipelines, automate deployments, and maintain our cloud infrastructure (AWS/GCP). Experience with Docker, Kubernetes, and infrastructure-as-code tools like Terraform is essential.'},
                'data-scientist': { title: 'Data Scientist', desc: 'Seeking a Data Scientist with a strong background in machine learning, statistical analysis, and data visualization. Must be proficient in Python and libraries like Pandas, Scikit-learn, and TensorFlow/PyTorch to derive insights from large datasets.'}
            };
            
            jdTemplateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const role = button.dataset.role;
                    jobTitleEl.value = jobTemplates[role].title;
                    jobDescriptionEl.value = jobTemplates[role].desc;
                    jdTemplateButtons.forEach(btn => btn.classList.remove('bg-indigo-500'));
                    button.classList.add('bg-indigo-500');
                });
            });

            async function loadDashboard() {
                const data = await apiCall('/api/dashboard_data');
                jobsContainer.innerHTML = '';
                if (data.length === 0) { jobsContainer.innerHTML = '<p class="text-gray-400">No jobs posted yet.</p>'; return; }
                data.forEach(job => {
                    const candidatesHtml = job.candidates.length > 0 ? `<ul>${job.candidates.map(c => `<li class="flex justify-between items-center text-sm py-1"><span>Candidate #${c.id}</span>${c.report_path ? `<a href="/api/download_report/${c.id}" class="text-indigo-400 hover:underline">Download Report</a>` : '<span class="text-gray-500">Pending</span>'}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-500 mt-2">No candidates yet.</p>';
                    jobsContainer.innerHTML += `<div class="bg-gray-900 p-4 rounded-lg mb-4"><h3 class="font-bold">${job.title}</h3><input type="text" readonly value="${window.location.origin}/interview/${job.id}" class="w-full bg-gray-800 text-sm p-1 rounded mt-1"><h4 class="text-sm font-semibold mt-3">Candidates:</h4>${candidatesHtml}</div>`;
                });
            }
            jdFileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                const data = await apiCall('/api/extract_text', { method: 'POST', body: formData });
                jobDescriptionEl.value = data.text;
            };
            createJobForm.onsubmit = async (e) => {
                e.preventDefault();
                const data = await apiCall('/api/create_job', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: jobTitleEl.value, description: jobDescriptionEl.value })
                });
                linkInput.value = data.interview_link;
                linkContainer.classList.remove('hidden');
                createJobForm.reset();
                loadDashboard();
            };
            document.getElementById('logout-btn').onclick = async () => {
                await apiCall('/api/logout');
                sessionStorage.clear();
                window.location.href = '/';
            };
            loadDashboard();
        }

        // --- CANDIDATE SETUP ---
        function initCandidateSetupView() {
            const resumeInput = document.getElementById('candidate-resume-input');
            const fileNameEl = document.getElementById('candidate-file-name');
            const startBtn = document.getElementById('start-interview-btn');

            resumeInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                fileNameEl.textContent = `Uploading...`;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const data = await apiCall('/api/extract_text', { method: 'POST', body: formData });
                    appState.resumeText = data.text;
                    fileNameEl.textContent = `✓ ${file.name}`;
                    startBtn.disabled = false;
                } catch(err) { fileNameEl.textContent = `✗ Error`; startBtn.disabled = true; }
            };
            startBtn.onclick = async () => {
                const data = await apiCall('/api/start_interview', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: appState.jobId, resume_text: appState.resumeText })
                });
                appState.questions = data.questions;
                appState.view = 'interview';
                views.candidateSetup.classList.add('hidden');
                views.interview.classList.remove('hidden');
                initInterviewView();
            };
        }

        // --- INTERVIEW VIEW & HELPERS ---
        function initInterviewView() {
            const recordBtn = document.getElementById('record-btn');
            const nextBtn = document.getElementById('next-btn');
            startProctoring().then(runQuestionCycle).catch(err => {
                alert("Could not start proctoring. Please check camera permissions and refresh.");
            });
            recordBtn.onclick = () => {
                 if (!appState.isRecording) startRecording();
                 else stopRecording();
            };
            nextBtn.onclick = () => {
                appState.currentQuestionIndex++;
                runQuestionCycle();
            };
        }
        
        async function runQuestionCycle() {
            if (appState.currentQuestionIndex >= appState.questions.length) {
                await generateFinalReport();
                return;
            }
            document.getElementById('ai-status-text').textContent = "Thinking...";
            document.getElementById('question-text').textContent = "";
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('record-btn').classList.remove('hidden');
            document.getElementById('record-btn').disabled = true;
            document.getElementById('answer-textarea').value = "";

            const formalQuestion = appState.questions[appState.currentQuestionIndex];
            const casualData = await apiCall('/api/make_casual', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: formalQuestion })
            });
            
            document.getElementById('question-text').textContent = casualData.casual_question || formalQuestion;
            await speakText(casualData.casual_question || formalQuestion);
            document.getElementById('ai-status-text').textContent = "Ready to answer";
            document.getElementById('record-btn').disabled = false;
        }

        async function generateFinalReport() {
            stopProctoring();
            appState.view = 'end';
            views.interview.classList.add('hidden');
            views.end.classList.remove('hidden');
            
            await apiCall('/api/generate_final_report', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    interview_results: appState.interviewResults,
                    proctoring_flags: appState.proctoringFlags
                })
            });
        }
        
        // --- Full Proctoring, Speech, and other helpers ---
        const proctorWarningText = document.getElementById('proctor-warning-text');
        const proctorWarningOverlay = document.getElementById('proctor-warning-overlay');
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 1) {
                if (!proctoringState.multiFaceTimeout) {
                    proctoringState.multiFaceTimeout = setTimeout(() => {
                        proctorWarningText.textContent = "alert";
                        proctorWarningOverlay.classList.add('visible');
                        appState.proctoringFlags.push(`Q${appState.currentQuestionIndex + 1}: Multiple faces detected`);
                    }, 1000);
                }
                canvasCtx.restore();
                return;
            } else {
                clearTimeout(proctoringState.multiFaceTimeout); proctoringState.multiFaceTimeout = null;
                if(proctorWarningText.textContent === "alert") proctorWarningOverlay.classList.remove('visible');
            }
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                let isMalpractice = false;
                const nose = landmarks[1];
                if (nose.x < 0.3 || nose.x > 0.7 || nose.y < 0.25 || nose.y > 0.75) isMalpractice = true;
                const fTop = landmarks[10], chin = landmarks[152], lCheek = landmarks[234], rCheek = landmarks[454];
                if(fTop && chin && lCheek && rCheek) {
                    if ((Math.abs(chin.y - fTop.y) / Math.abs(rCheek.x - lCheek.x)) < 1.3) isMalpractice = true;
                }
                if (isMalpractice) {
                    if (!proctoringState.focusTimeout) {
                        proctoringState.focusTimeout = setTimeout(() => {
                           if (proctorWarningText.textContent !== 'alert') {
                                proctorWarningText.textContent = "focus";
                                proctorWarningOverlay.classList.add('visible');
                           }
                           appState.proctoringFlags.push(`Q${appState.currentQuestionIndex + 1}: Lack of focus`);
                        }, 1500);
                    }
                } else {
                    clearTimeout(proctoringState.focusTimeout); proctoringState.focusTimeout = null;
                    if (proctorWarningText.textContent === "focus") proctorWarningOverlay.classList.remove('visible');
                }
            }
            canvasCtx.restore();
        }
        function startProctoring() {
            return new Promise(async (resolve, reject) => {
                document.getElementById('proctor-status-text').textContent = "Initializing Camera...";
                document.getElementById('proctor-status-indicator').classList.replace('bg-gray-500', 'bg-yellow-500');
                try {
                    proctoringState.faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                    proctoringState.faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                    proctoringState.faceMesh.onResults(onResults);
                    await proctoringState.faceMesh.initialize();
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoElement.srcObject = stream;
                    videoElement.onloadedmetadata = async () => {
                        proctoringState.camera = new Camera(videoElement, { onFrame: async () => await proctoringState.faceMesh.send({image: videoElement}), width: 640, height: 480 });
                        await proctoringState.camera.start();
                        document.getElementById('proctor-status-indicator').classList.replace('bg-yellow-500', 'bg-green-500');
                        document.getElementById('proctor-status-text').textContent = "Proctoring Active";
                        resolve();
                    };
                } catch (err) { stopProctoring(); reject(err); }
            });
        }
        function stopProctoring() {
            clearTimeout(proctoringState.focusTimeout); clearTimeout(proctoringState.multiFaceTimeout);
            if (proctoringState.camera) proctoringState.camera.stop();
            if (videoElement.srcObject) videoElement.srcObject.getTracks().forEach(track => track.stop());
            if (proctoringState.faceMesh) proctoringState.faceMesh.close();
            document.getElementById('proctor-status-indicator').classList.replace('bg-green-500', 'bg-gray-500');
            document.getElementById('proctor-status-text').textContent = "Proctoring Offline";
        }
        function speakText(text) { /* ... same as previous ... */ }
        function startRecording() { /* ... same as previous ... */ }
        function stopRecording() { /* ... same as previous ... */ }

        // --- INITIALIZE APP ---
        navigate();
    </script>
</body>
</html>

