<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
    </style>
</head>
<body class="text-gray-200">
    <div class="p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 id="company-name-header" class="text-2xl font-bold">Admin Dashboard</h1>
            <a href="/api/logout" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Logout</a>
        </header>
        
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4">Create New Job Posting</h2>
            <form id="create-job-form" class="space-y-4">
                <input type="text" id="job-title" placeholder="Job Title (e.g., Senior Python Developer)" required class="w-full bg-gray-900 border border-gray-700 rounded-md p-3">
                <div class="space-y-2">
                     <label class="block text-sm font-medium text-gray-400">Job Description Templates</label>
                     <div class="flex flex-wrap gap-2">
                         <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="frontend">Frontend Developer</button>
                         <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="backend">Backend Developer</button>
                         <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="devops">DevOps Engineer</button>
                         <button type="button" class="jd-template-btn bg-gray-700 text-gray-300 text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-500" data-role="data-scientist">Data Scientist</button>
                     </div>
                </div>
                <div class="flex items-center gap-4">
                    <label class="bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer">
                        <span>Upload JD (PDF/DOCX)</span>
                        <input type="file" id="jd-file-input" class="hidden" accept=".pdf,.docx">
                    </label>
                     <textarea id="job-description" placeholder="Or paste job description here..." required class="w-full h-24 p-3 bg-gray-900 border border-gray-700 rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Create Job & Get Link</button>
            </form>
            <div id="interview-link-container" class="mt-4 hidden">
                <p class="text-green-400">Share this link with candidates:</p>
                <input id="interview-link-input" type="text" readonly class="w-full bg-gray-900 p-2 rounded-md border border-gray-700 mt-2">
            </div>
        </div>

        <div id="jobs-container">
            <p class="text-gray-400">Loading jobs...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const companyName = sessionStorage.getItem('companyName') || 'Admin';
            document.getElementById('company-name-header').textContent = `${companyName} Dashboard`;

            const createJobForm = document.getElementById('create-job-form');
            const jobsContainer = document.getElementById('jobs-container');
            const linkContainer = document.getElementById('interview-link-container');
            const linkInput = document.getElementById('interview-link-input');
            const jdFileInput = document.getElementById('jd-file-input');
            const jobDescriptionEl = document.getElementById('job-description');
            const jobTitleEl = document.getElementById('job-title');
            const jdTemplateButtons = document.querySelectorAll('.jd-template-btn');

            const jobTemplates = {
                'frontend': { title: 'Frontend Developer', desc: 'Seeking a skilled Frontend Developer with experience in HTML, CSS, JavaScript, and modern frameworks like React or Vue.js. The ideal candidate will be passionate about creating responsive, user-friendly interfaces and collaborating with our design team to bring concepts to life.'},
                'backend': { title: 'Backend Developer', desc: 'We are looking for a Backend Developer proficient in server-side languages such as Python, Node.js, or Java. Responsibilities include designing and managing databases (SQL/NoSQL), building robust APIs, and ensuring the performance and scalability of our application.'},
                'devops': { title: 'DevOps Engineer', desc: 'Hiring a DevOps Engineer to manage our CI/CD pipelines, automate deployments, and maintain our cloud infrastructure (AWS/GCP). Experience with Docker, Kubernetes, and infrastructure-as-code tools like Terraform is essential.'},
                'data-scientist': { title: 'Data Scientist', desc: 'Seeking a Data Scientist with a strong background in machine learning, statistical analysis, and data visualization. Must be proficient in Python and libraries like Pandas, Scikit-learn, and TensorFlow/PyTorch to derive insights from large datasets.'}
            };

            jdTemplateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const role = button.dataset.role;
                    jobTitleEl.value = jobTemplates[role].title;
                    jobDescriptionEl.value = jobTemplates[role].desc;
                    jdTemplateButtons.forEach(btn => btn.classList.remove('bg-indigo-500'));
                    button.classList.add('bg-indigo-500');
                });
            });

            async function loadDashboard() {
                try {
                    const response = await fetch('/api/dashboard_data');
                    if (!response.ok) {
                        window.location.href = '/'; // Redirect if not authorized
                        return;
                    }
                    const data = await response.json();
                    jobsContainer.innerHTML = '';
                    if (data.length === 0) { jobsContainer.innerHTML = '<p class="text-gray-400">No jobs posted yet.</p>'; return; }
                    data.forEach(job => {
                        const candidatesHtml = job.candidates.length > 0
                            ? `<ul class="mt-2 space-y-1">${job.candidates.map(c => `<li class="flex justify-between items-center text-sm py-1"><span>Candidate #${c.id}</span>${c.report_path ? `<a href="/api/download_report/${c.id}" class="text-indigo-400 hover:underline">Download Report</a>` : '<span class="text-gray-500">Pending</span>'}</li>`).join('')}</ul>`
                            : '<p class="text-sm text-gray-500 mt-2">No candidates yet.</p>';
                        jobsContainer.innerHTML += `
                            <div class="bg-gray-900 p-4 rounded-lg mb-4">
                                <h3 class="font-bold">${job.title}</h3>
                                <div class="relative"><input type="text" readonly value="${window.location.origin}/interview/${job.id}" class="w-full bg-gray-800 text-sm p-1 rounded pr-10 mt-1"><button class="absolute inset-y-0 right-0 px-2 text-gray-400 hover:text-white" onclick="navigator.clipboard.writeText('${window.location.origin}/interview/${job.id}'); alert('Link copied!');">Copy</button></div>
                                <h4 class="text-sm font-semibold mt-3">Candidates:</h4>
                                ${candidatesHtml}
                            </div>`;
                    });
                } catch (error) {
                    console.error('Failed to load dashboard:', error);
                    window.location.href = '/';
                }
            }

            jdFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/extract_text', { method: 'POST', body: formData });
                    const data = await response.json();
                    if(!response.ok) throw new Error(data.error);
                    jobDescriptionEl.value = data.text;
                } catch(error) {
                    alert(error.message);
                }
            });

            createJobForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/create_job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: jobTitleEl.value, description: jobDescriptionEl.value })
                    });
                    const data = await response.json();
                    if(!response.ok) throw new Error(data.error);
                    linkInput.value = data.interview_link;
                    linkContainer.classList.remove('hidden');
                    createJobForm.reset();
                    jdTemplateButtons.forEach(btn => btn.classList.remove('bg-indigo-500'));
                    loadDashboard();
                } catch(error) {
                    alert(error.message);
                }
            });

            loadDashboard();
        });
    </script>
</body>
</html>